<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESEngine Preview</title>
    <script type="importmap">
    {
        "imports": {
            "esengine": "/esengine-sdk.js"
        }
    }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #1a1a2e; }
        #canvas { width: 100%; height: 100%; display: block; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e0e0e0;
            font-family: system-ui, sans-serif;
            font-size: 14px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-family: monospace;
            font-size: 13px;
            max-width: 80%;
            white-space: pre-wrap;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="loading">Loading...</div>
    <div id="error"></div>

    <script type="module">
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        function updateLoading(message) {
            loading.textContent = message;
        }

        function showError(msg) {
            loading.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.textContent = msg;
            console.error('Preview Error:', msg);
        }

        function setupCanvas() {
            const canvas = document.getElementById('canvas');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            return canvas;
        }

        function getCanvasViewportSize() {
            const canvas = document.getElementById('canvas');
            return { width: canvas.width, height: canvas.height };
        }

        async function loadPreview() {
            try {
                updateLoading('Loading WASM module...');
                const ModuleLoader = await import('/esengine.js');
                const Module = await ModuleLoader.default();

                updateLoading('Loading SDK...');
                const sdk = await import('/esengine-sdk.js');

                // Load user scripts to register custom components (but don't call main)
                try {
                    await import('/.esengine/preview/user-scripts.js');
                    console.log('User scripts loaded (components registered)');
                } catch (e) {
                    console.log('No user scripts found');
                }

                updateLoading('Loading scene...');
                setupCanvas();
                window.addEventListener('resize', () => setupCanvas());

                const previewPlugin = new sdk.PreviewPlugin('/.esengine/preview/scene.json');

                const app = sdk.createWebApp(Module, {
                    getViewportSize: getCanvasViewportSize
                });
                app.addPlugin(sdk.assetPlugin);
                app.addPlugin(previewPlugin);

                await previewPlugin.waitForReady();

                loading.style.display = 'none';
                app.run();
            } catch (err) {
                showError(err.message || String(err));
            }
        }

        loadPreview();
    </script>
</body>
</html>
