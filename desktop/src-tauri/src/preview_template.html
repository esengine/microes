<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESEngine Preview</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #1a1a2e; }
        #canvas { width: 100%; height: 100%; display: block; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e0e0e0;
            font-family: system-ui, sans-serif;
            font-size: 14px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-family: monospace;
            font-size: 13px;
            max-width: 80%;
            white-space: pre-wrap;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="loading">Loading...</div>
    <div id="error"></div>

    <script type="module">
        import {
            createWebApp,
            assetPlugin,
            textPlugin,
            PreviewPlugin
        } from '/esengine-sdk.js';

        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        function updateLoading(message) {
            loading.textContent = message;
        }

        function showError(msg) {
            loading.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.textContent = msg;
            console.error('Preview Error:', msg);
        }

        async function loadPreview() {
            try {
                updateLoading('Loading WASM module...');
                const ModuleLoader = await import('/esengine.js');
                const Module = await ModuleLoader.default();

                let userMain = null;
                try {
                    const userModule = await import('/.esengine/preview/user-scripts.js');
                    if (typeof userModule.main === 'function') {
                        userMain = userModule.main;
                    }
                } catch (e) {
                    console.log('No user main function, using default preview');
                }

                if (userMain) {
                    await runWithUserMain(Module, userMain);
                } else {
                    await runDefaultPreview(Module);
                }

                loading.style.display = 'none';
            } catch (err) {
                showError(err.message || String(err));
            }
        }

        async function runWithUserMain(Module, userMain) {
            updateLoading('Loading scene...');

            setupCanvas();
            window.addEventListener('resize', () => {
                setupCanvas();
            });

            const previewPlugin = new PreviewPlugin('/.esengine/preview/scene.json');
            const origCreate = createWebApp;

            const patchedCreate = (module, options) => {
                const mergedOptions = {
                    ...options,
                    getViewportSize: options?.getViewportSize ?? getCanvasViewportSize
                };
                const app = origCreate(module, mergedOptions);
                app.addPlugin(previewPlugin);
                return app;
            };

            window.esengine = window.esengine || {};
            window.esengine.createWebApp = patchedCreate;

            const sdkModule = await import('/esengine-sdk.js');
            Object.defineProperty(sdkModule, 'createWebApp', {
                value: patchedCreate,
                writable: true
            });

            await userMain(Module);

            // Wait for scene to be loaded
            await previewPlugin.waitForReady();
        }

        function setupCanvas() {
            const canvas = document.getElementById('canvas');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            return canvas;
        }

        function getCanvasViewportSize() {
            const canvas = document.getElementById('canvas');
            return { width: canvas.width, height: canvas.height };
        }

        async function runDefaultPreview(Module) {
            updateLoading('Loading scene...');

            // IMPORTANT: Setup canvas BEFORE creating WebGL context
            setupCanvas();

            const previewPlugin = new PreviewPlugin('/.esengine/preview/scene.json');

            const app = createWebApp(Module, {
                getViewportSize: getCanvasViewportSize
            });
            app.addPlugin(assetPlugin);
            app.addPlugin(textPlugin);
            app.addPlugin(previewPlugin);

            // Setup resize handler AFTER app is created
            window.addEventListener('resize', () => {
                setupCanvas();
            });

            // Wait for scene to be loaded before starting render loop
            await previewPlugin.waitForReady();

            updateLoading('Starting renderer...');
            app.run();
        }

        loadPreview();
    </script>
</body>
</html>
