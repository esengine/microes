<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESEngine Preview</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background: #1a1a2e; }
        #canvas { width: 100%; height: 100%; display: block; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e0e0e0;
            font-family: system-ui, sans-serif;
            font-size: 14px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-family: monospace;
            font-size: 13px;
            max-width: 80%;
            white-space: pre-wrap;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="loading">Loading...</div>
    <div id="error"></div>

    <script type="module">
        import {
            createWebApp,
            assetPlugin,
            PreviewPlugin
        } from '/esengine-sdk.js';

        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');

        function showError(msg) {
            loading.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.textContent = msg;
            console.error('Preview Error:', msg);
        }

        async function loadPreview() {
            try {
                const ModuleLoader = await import('/esengine.js');
                const Module = await ModuleLoader.default();

                let userMain = null;
                try {
                    const userModule = await import('/.esengine/preview/user-scripts.js');
                    if (typeof userModule.main === 'function') {
                        userMain = userModule.main;
                    }
                } catch (e) {
                    console.log('No user main function, using default preview');
                }

                if (userMain) {
                    await runWithUserMain(Module, userMain);
                } else {
                    await runDefaultPreview(Module);
                }

                loading.style.display = 'none';
            } catch (err) {
                showError(err.message || String(err));
            }
        }

        async function runWithUserMain(Module, userMain) {
            const origCreate = createWebApp;

            const patchedCreate = (module, options) => {
                const app = origCreate(module, options);
                app.addPlugin(new PreviewPlugin('/.esengine/preview/scene.json'));
                return app;
            };

            window.esengine = window.esengine || {};
            window.esengine.createWebApp = patchedCreate;

            const sdkModule = await import('/esengine-sdk.js');
            Object.defineProperty(sdkModule, 'createWebApp', {
                value: patchedCreate,
                writable: true
            });

            await userMain(Module);
        }

        async function runDefaultPreview(Module) {
            const app = createWebApp(Module);
            app.addPlugin(assetPlugin);
            app.addPlugin(new PreviewPlugin('/.esengine/preview/scene.json'));
            app.run();
        }

        loadPreview();
    </script>
</body>
</html>
