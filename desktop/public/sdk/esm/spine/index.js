let e=0;function t(t,n){const i=++e;return{_id:Symbol(`Resource_${i}_${n??""}`),_name:n??`Resource_${i}`,_default:t}}t({delta:0,elapsed:0,frameCount:0},"Time");function n(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(n);const t={};for(const i in e)t[i]=n(e[i]);return t}let i=0;const r=new Map;function s(e,t){const n={_id:Symbol(`Builtin_${e}`),_name:e,_cppName:e,_builtin:!0,_default:t};return r.set(e,n),n}s("LocalTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}});const a=s("WorldTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}});s("Sprite",{texture:4294967295,color:{r:1,g:1,b:1,a:1},size:{x:32,y:32},uvOffset:{x:0,y:0},uvScale:{x:1,y:1},layer:0,flipX:!1,flipY:!1,material:0}),s("Camera",{projectionType:1,fov:60,orthoSize:540,nearPlane:.1,farPlane:1e3,aspectRatio:1.77,isActive:!0,priority:0,showFrustum:!1,viewportX:0,viewportY:0,viewportW:1,viewportH:1,clearFlags:3}),s("Canvas",{designResolution:{x:1920,y:1080},pixelsPerUnit:100,scaleMode:1,matchWidthOrHeight:.5,backgroundColor:{r:0,g:0,b:0,a:1}}),s("Velocity",{linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}}),s("Parent",{entity:0}),s("Children",{entities:[]}),s("BitmapText",{text:"",color:{r:1,g:1,b:1,a:1},fontSize:1,align:0,spacing:0,layer:0,font:4294967295});const o=s("SpineAnimation",{skeletonPath:"",atlasPath:"",skin:"",animation:"",timeScale:1,loop:!0,playing:!0,flipX:!1,flipY:!1,color:{r:1,g:1,b:1,a:1},layer:0,skeletonScale:1,material:0}),l={_id:Symbol("Component_Name"),_name:"Name",_default:{value:""},_builtin:!1,create:e=>({value:"",...e})};var u,c,p;!function(e,t){const r="undefined"==typeof window?new Map:window.__esengine_componentRegistry??(window.__esengine_componentRegistry=new Map),s=r.get(e);if(s)return s;const a=function(e,t){const r=++i;return{_id:Symbol(`Component_${r}_${e}`),_name:e,_default:t,_builtin:!1,create:e=>e?{...n(t),...e}:n(t)}}(e,t);r.set(e,a),function(e,t,n){"undefined"!=typeof window&&window.__esengine_registerComponent&&window.__esengine_registerComponent(e,t,n)}(e,t,!1)}("SceneOwner",{scene:"",persistent:!1}),u="Name",c=l,r.set(u,c),function(e){e[e.Startup=0]="Startup",e[e.First=1]="First",e[e.PreUpdate=2]="PreUpdate",e[e.Update=3]="Update",e[e.PostUpdate=4]="PostUpdate",e[e.Last=5]="Last",e[e.FixedPreUpdate=10]="FixedPreUpdate",e[e.FixedUpdate=11]="FixedUpdate",e[e.FixedPostUpdate=12]="FixedPostUpdate"}(p||(p={}));const _=t(null,"Assets");function m(e){const t=e.cwrap.bind(e);return{loadSkeleton:t("spine_loadSkeleton","number",["number","number","string","number","number"]),getLastError:t("spine_getLastError","string",[]),unloadSkeleton:t("spine_unloadSkeleton",null,["number"]),getAtlasPageCount:t("spine_getAtlasPageCount","number",["number"]),getAtlasPageTextureName:t("spine_getAtlasPageTextureName","string",["number","number"]),setAtlasPageTexture:t("spine_setAtlasPageTexture",null,["number","number","number","number","number"]),createInstance:t("spine_createInstance","number",["number"]),destroyInstance:t("spine_destroyInstance",null,["number"]),playAnimation:t("spine_playAnimation","number",["number","string","number","number"]),addAnimation:t("spine_addAnimation","number",["number","string","number","number","number"]),setSkin:t("spine_setSkin",null,["number","string"]),update:t("spine_update",null,["number","number"]),getAnimations:t("spine_getAnimations","string",["number"]),getSkins:t("spine_getSkins","string",["number"]),getBonePosition:t("spine_getBonePosition","number",["number","string","number","number"]),getBoneRotation:t("spine_getBoneRotation","number",["number","string"]),getBounds:t("spine_getBounds",null,["number","number","number","number","number"]),getMeshBatchCount:t("spine_getMeshBatchCount","number",["number"]),getMeshBatchVertexCount:t("spine_getMeshBatchVertexCount","number",["number","number"]),getMeshBatchIndexCount:t("spine_getMeshBatchIndexCount","number",["number","number"]),getMeshBatchData:t("spine_getMeshBatchData",null,["number","number","number","number","number","number"])}}async function h(e,t){if(!t)throw new Error("SpineModuleLoader: factory parameter is required. Pass the Spine WASM factory function explicitly via loadSpineModule(url, factory).");const n=await t();return{raw:n,api:m(n)}}class d{constructor(e,t){this.raw_=e,this.api_=t,this.listeners_=new Map}get raw(){return this.raw_}loadSkeleton(e,t,n){let i,r;if("string"==typeof e){const t=(new TextEncoder).encode(e);r=t.length,i=this.raw_._malloc(r+1),this.raw_.HEAPU8.set(t,i),this.raw_.HEAPU8[i+r]=0}else r=e.length,i=this.raw_._malloc(r),this.raw_.HEAPU8.set(e,i);const s=this.api_.loadSkeleton(i,r,t,t.length,n);return this.raw_._free(i),s}getLastError(){return this.api_.getLastError()}unloadSkeleton(e){this.api_.unloadSkeleton(e)}getAtlasPageCount(e){return this.api_.getAtlasPageCount(e)}getAtlasPageTextureName(e,t){return this.api_.getAtlasPageTextureName(e,t)}setAtlasPageTexture(e,t,n,i,r){this.api_.setAtlasPageTexture(e,t,n,i,r)}createInstance(e){return this.api_.createInstance(e)}destroyInstance(e){this.api_.destroyInstance(e),this.listeners_.delete(e)}play(e,t,n=!0,i=0){return!!this.api_.playAnimation(e,t,n,i)}addAnimation(e,t,n=!0,i=0,r=0){return!!this.api_.addAnimation(e,t,n,i,r)}setSkin(e,t){this.api_.setSkin(e,t)}update(e,t){this.api_.update(e,t)}getAnimations(e){const t=this.api_.getAnimations(e);try{return JSON.parse(t)}catch{return[]}}getSkins(e){const t=this.api_.getSkins(e);try{return JSON.parse(t)}catch{return[]}}getBonePosition(e,t){const n=this.raw_._malloc(4),i=this.raw_._malloc(4);if(!this.api_.getBonePosition(e,t,n,i))return this.raw_._free(n),this.raw_._free(i),null;const r=this.raw_.HEAPF32[n>>2],s=this.raw_.HEAPF32[i>>2];return this.raw_._free(n),this.raw_._free(i),{x:r,y:s}}getBoneRotation(e,t){return this.api_.getBoneRotation(e,t)}getBounds(e){const t=this.raw_._malloc(16);this.api_.getBounds(e,t,t+4,t+8,t+12);const n=this.raw_.HEAPF32,i=t>>2,r={x:n[i],y:n[i+1],width:n[i+2],height:n[i+3]};return this.raw_._free(t),r}extractMeshBatches(e){const t=this.api_.getMeshBatchCount(e),n=[],i=this.raw_._malloc(8),r=i,s=i+4;for(let i=0;i<t;i++){const t=this.api_.getMeshBatchVertexCount(e,i),a=this.api_.getMeshBatchIndexCount(e,i);if(t<=0||a<=0)continue;const o=8*t*4,l=2*a,u=this.raw_._malloc(o),c=this.raw_._malloc(l);this.api_.getMeshBatchData(e,i,u,c,r,s);const p=new Float32Array(this.raw_.HEAPF32.buffer,u,8*t),_=new Uint16Array(this.raw_.HEAPU8.buffer,c,a);n.push({vertices:new Float32Array(p),indices:new Uint16Array(_),textureId:this.raw_.HEAPU32[r>>2],blendMode:this.raw_.HEAPU32[s>>2]}),this.raw_._free(u),this.raw_._free(c)}return this.raw_._free(i),n}on(e,t,n){this.listeners_.has(e)||this.listeners_.set(e,new Map);const i=this.listeners_.get(e);i.has(t)||i.set(t,new Set),i.get(t).add(n)}off(e,t,n){const i=this.listeners_.get(e);if(!i)return;const r=i.get(t);r&&r.delete(n)}removeAllListeners(e){this.listeners_.delete(e)}}const g=t(null,"SpineController"),f=new Float32Array(16);function b(e,t,n,i){const r=e.scale.x*t*(n?-1:1),s=e.scale.y*t*(i?-1:1),a=e.scale.z,o=e.rotation.x,l=e.rotation.y,u=e.rotation.z,c=e.rotation.w,p=o+o,_=l+l,m=u+u,h=o*p,d=o*_,g=o*m,b=l*_,w=l*m,y=u*m,S=c*p,A=c*_,P=c*m;return f[0]=(1-(b+y))*r,f[1]=(d+P)*r,f[2]=(g-A)*r,f[3]=0,f[4]=(d-P)*s,f[5]=(1-(h+y))*s,f[6]=(w+S)*s,f[7]=0,f[8]=(g+A)*a,f[9]=(w-S)*a,f[10]=(1-(h+b))*a,f[11]=0,f[12]=e.position.x,f[13]=e.position.y,f[14]=e.position.z,f[15]=1,f}class w{constructor(e,t){this.wasmUrl_=e,this.factory_=t}build(e){const t=e.wasmModule,n=h(this.wasmUrl_,this.factory_).then(({raw:n,api:i})=>{const r=new d(n,i);e.insertResource(g,r),e.hasResource(_)&&e.getResource(_).setSpineController(r);const s=new Map,l=new Map,u=new Map,c={_id:Symbol("SpineAutoSystem"),_name:"SpineAutoSystem",_params:[],_fn:()=>{const t=e.world,n=e.hasResource(_)?e.getResource(_):null;if(!n)return;const i=t.getEntitiesWithComponents([o]),a=new Set;for(const e of i){a.add(e);const i=t.get(e,o),c=`${i.skeletonPath}:${i.atlasPath}`;if(!s.has(e)||l.get(e)!==c){s.has(e)&&(r.destroyInstance(s.get(e)),s.delete(e),l.delete(e),u.delete(e));const t=n.getSpineSkeletonHandle(i.skeletonPath,i.atlasPath);if(void 0===t)continue;const a=r.createInstance(t);if(a<0)continue;s.set(e,a),l.set(e,c),i.skin&&r.setSkin(a,i.skin),i.animation&&r.play(a,i.animation,i.loop),u.set(e,{animation:i.animation,skin:i.skin,loop:i.loop});continue}const p=u.get(e);if(!p)continue;const _=s.get(e);p.skin!==i.skin&&(r.setSkin(_,i.skin),p.skin=i.skin),p.animation===i.animation&&p.loop===i.loop||(i.animation&&r.play(_,i.animation,i.loop),p.animation=i.animation,p.loop=i.loop)}for(const[e,t]of s)a.has(e)||(r.destroyInstance(t),s.delete(e),l.delete(e),u.delete(e))}};if(e.addSystemToSchedule(p.PreUpdate,c),!e.pipeline?.spineRenderer){let n=0;e.setSpineRenderer((i,l)=>{let u=l-n;n=l,(u<=0||u>.5)&&(u=1/60);const c=e.world;for(const[e,n]of s){const i=c.has(e,o)?c.get(e,o):null,s=!1!==i?.playing,l=i?.timeScale??1;let p;if(s&&r.update(n,u*l),c.has(e,a)){p=b(c.get(e,a),i?.skeletonScale??1,i?.flipX??!1,i?.flipY??!1)}const _=i?.color;U(t,r,n,p,_)}})}return{controller:r,coreModule:t}});e.insertResource(g,null),n.catch(()=>{}),e.spineInitPromise=n}}let y=new Float32Array(0),S=0,A=0,P=0,x=0,k=0,M=null;function B(e,t,n,i){if(t&&n>=i)return[t,n];t&&e._free(t);const r=2*i;return[e._malloc(r),r]}function U(e,t,n,i,r){M&&M!==e&&M&&(S&&(M._free(S),S=0,A=0),P&&(M._free(P),P=0,x=0),k&&(M._free(k),k=0),M=null),M=e;const s=t.extractMeshBatches(n);i&&(k||(k=e._malloc(64)),e.HEAPF32.set(i,k>>2));const a=r&&(1!==r.r||1!==r.g||1!==r.b||1!==r.a);for(const t of s){let n=t.vertices;if(a){const e=t.blendMode>=4;y.length<n.length&&(y=new Float32Array(2*n.length)),y.set(n);const i=y.subarray(0,n.length);for(let t=0;t<i.length;t+=8)e?(i[t+4]*=r.r*r.a,i[t+5]*=r.g*r.a,i[t+6]*=r.b*r.a):(i[t+4]*=r.r,i[t+5]*=r.g,i[t+6]*=r.b),i[t+7]*=r.a;n=i}const s=n.byteLength,o=t.indices.byteLength;[S,A]=B(e,S,A,s),[P,x]=B(e,P,x,o),e.HEAPF32.set(n,S>>2),new Uint16Array(e.HEAPU8.buffer,P,t.indices.length).set(t.indices),e.renderer_submitTriangles(S,n.length/8,P,t.indices.length,t.textureId,t.blendMode,i?k:0)}}export{d as SpineModuleController,w as SpinePlugin,g as SpineResource,h as loadSpineModule,U as submitSpineMeshesToCore,m as wrapSpineModule};
//# sourceMappingURL=index.js.map
