let e=0;function t(t,n){const s=++e;return{_id:Symbol(`Resource_${s}_${n??""}`),_name:n??`Resource_${s}`,_default:t}}t({delta:0,elapsed:0,frameCount:0},"Time");function n(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(n);const t={};for(const s in e)t[s]=n(e[s]);return t}let s=0;const a=new Map;function i(e,t){const n={_id:Symbol(`Builtin_${e}`),_name:e,_cppName:e,_builtin:!0,_default:t};return a.set(e,n),n}i("LocalTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}});const r=i("WorldTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}});i("Sprite",{texture:4294967295,color:{r:1,g:1,b:1,a:1},size:{x:32,y:32},uvOffset:{x:0,y:0},uvScale:{x:1,y:1},layer:0,flipX:!1,flipY:!1,material:0,enabled:!0}),i("Camera",{projectionType:1,fov:60,orthoSize:540,nearPlane:.1,farPlane:1e3,aspectRatio:1.77,isActive:!0,priority:0,showFrustum:!1,viewportX:0,viewportY:0,viewportW:1,viewportH:1,clearFlags:3}),i("Canvas",{designResolution:{x:1920,y:1080},pixelsPerUnit:100,scaleMode:1,matchWidthOrHeight:.5,backgroundColor:{r:0,g:0,b:0,a:1}}),i("Velocity",{linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}}),i("Parent",{entity:0}),i("Children",{entities:[]}),i("BitmapText",{text:"",color:{r:1,g:1,b:1,a:1},fontSize:1,align:0,spacing:0,layer:0,font:4294967295,enabled:!0});const o=i("SpineAnimation",{skeletonPath:"",atlasPath:"",skin:"",animation:"",timeScale:1,loop:!0,playing:!0,flipX:!1,flipY:!1,color:{r:1,g:1,b:1,a:1},layer:0,skeletonScale:1,material:0,enabled:!0}),l={_id:Symbol("Component_Name"),_name:"Name",_default:{value:""},_builtin:!1,create:e=>({value:"",...e})};var c,u,p,d;!function(e,t){const a="undefined"==typeof window?new Map:window.__esengine_componentRegistry??(window.__esengine_componentRegistry=new Map),i=a.get(e);if(i)return i;const r=function(e,t){const a=++s;return{_id:Symbol(`Component_${a}_${e}`),_name:e,_default:t,_builtin:!1,create:e=>e?{...n(t),...e}:n(t)}}(e,t);a.set(e,r),function(e,t,n){"undefined"!=typeof window&&window.__esengine_registerComponent&&window.__esengine_registerComponent(e,t,n)}(e,t,!1)}("SceneOwner",{scene:"",persistent:!1}),c="Name",u=l,a.set(c,u),function(e){e[e.Startup=0]="Startup",e[e.First=1]="First",e[e.PreUpdate=2]="PreUpdate",e[e.Update=3]="Update",e[e.PostUpdate=4]="PostUpdate",e[e.Last=5]="Last",e[e.FixedPreUpdate=10]="FixedPreUpdate",e[e.FixedUpdate=11]="FixedUpdate",e[e.FixedPostUpdate=12]="FixedPostUpdate"}(p||(p={})),function(e){e[e.Normal=0]="Normal",e[e.Additive=1]="Additive",e[e.Multiply=2]="Multiply",e[e.Screen=3]="Screen",e[e.PremultipliedAlpha=4]="PremultipliedAlpha"}(d||(d={}));const h=[{extensions:["png","jpg","jpeg","gif","webp","svg"],contentType:"image",editorType:"texture",addressableType:"texture",wechatPackInclude:!1,hasTransitiveDeps:!1},{extensions:["mp3","wav","ogg"],contentType:"audio",editorType:"audio",addressableType:"audio",wechatPackInclude:!1,hasTransitiveDeps:!1},{extensions:["esmaterial"],contentType:"json",editorType:"material",addressableType:"material",wechatPackInclude:!0,hasTransitiveDeps:!0},{extensions:["esshader"],contentType:"text",editorType:"shader",addressableType:null,wechatPackInclude:!1,hasTransitiveDeps:!1},{extensions:["atlas"],contentType:"text",editorType:"spine-atlas",addressableType:"binary",wechatPackInclude:!0,hasTransitiveDeps:!0},{extensions:["skel"],contentType:"binary",editorType:"spine-skeleton",addressableType:"spine",wechatPackInclude:!0,hasTransitiveDeps:!0},{extensions:["json"],contentType:"json",editorType:"json",addressableType:"json",wechatPackInclude:!1,hasTransitiveDeps:!1},{extensions:["bmfont"],contentType:"json",editorType:"bitmap-font",addressableType:"bitmap-font",wechatPackInclude:!0,hasTransitiveDeps:!0},{extensions:["fnt"],contentType:"text",editorType:"bitmap-font",addressableType:"bitmap-font",wechatPackInclude:!0,hasTransitiveDeps:!0},{extensions:["esprefab"],contentType:"json",editorType:"prefab",addressableType:"prefab",wechatPackInclude:!0,hasTransitiveDeps:!0},{extensions:["esscene"],contentType:"json",editorType:"scene",addressableType:null,wechatPackInclude:!1,hasTransitiveDeps:!1}],m=new Map,_=new Set;for(const e of h)for(const t of e.extensions)m.set(t,e),_.add(t);const g=t(null,"Assets");function b(e){const t=e.cwrap.bind(e);return{loadSkeleton:t("spine_loadSkeleton","number",["number","number","string","number","number"]),getLastError:t("spine_getLastError","string",[]),unloadSkeleton:t("spine_unloadSkeleton",null,["number"]),getAtlasPageCount:t("spine_getAtlasPageCount","number",["number"]),getAtlasPageTextureName:t("spine_getAtlasPageTextureName","string",["number","number"]),setAtlasPageTexture:t("spine_setAtlasPageTexture",null,["number","number","number","number","number"]),createInstance:t("spine_createInstance","number",["number"]),destroyInstance:t("spine_destroyInstance",null,["number"]),playAnimation:t("spine_playAnimation","number",["number","string","number","number"]),addAnimation:t("spine_addAnimation","number",["number","string","number","number","number"]),setSkin:t("spine_setSkin",null,["number","string"]),update:t("spine_update",null,["number","number"]),getAnimations:t("spine_getAnimations","string",["number"]),getSkins:t("spine_getSkins","string",["number"]),getBonePosition:t("spine_getBonePosition","number",["number","string","number","number"]),getBoneRotation:t("spine_getBoneRotation","number",["number","string"]),getBounds:t("spine_getBounds",null,["number","number","number","number","number"]),getMeshBatchCount:t("spine_getMeshBatchCount","number",["number"]),getMeshBatchVertexCount:t("spine_getMeshBatchVertexCount","number",["number","number"]),getMeshBatchIndexCount:t("spine_getMeshBatchIndexCount","number",["number","number"]),getMeshBatchData:t("spine_getMeshBatchData",null,["number","number","number","number","number","number"])}}async function y(e,t){if(!t)throw new Error("SpineModuleLoader: factory parameter is required. Pass the Spine WASM factory function explicitly via loadSpineModule(url, factory).");const n=await t();return{raw:n,api:b(n)}}class f{constructor(e,t){this.raw_=e,this.api_=t,this.listeners_=new Map}get raw(){return this.raw_}loadSkeleton(e,t,n){let s,a;if("string"==typeof e){const t=(new TextEncoder).encode(e);a=t.length,s=this.raw_._malloc(a+1),this.raw_.HEAPU8.set(t,s),this.raw_.HEAPU8[s+a]=0}else a=e.length,s=this.raw_._malloc(a),this.raw_.HEAPU8.set(e,s);const i=this.api_.loadSkeleton(s,a,t,t.length,n);return this.raw_._free(s),i}getLastError(){return this.api_.getLastError()}unloadSkeleton(e){this.api_.unloadSkeleton(e)}getAtlasPageCount(e){return this.api_.getAtlasPageCount(e)}getAtlasPageTextureName(e,t){return this.api_.getAtlasPageTextureName(e,t)}setAtlasPageTexture(e,t,n,s,a){this.api_.setAtlasPageTexture(e,t,n,s,a)}createInstance(e){return this.api_.createInstance(e)}destroyInstance(e){this.api_.destroyInstance(e),this.listeners_.delete(e)}play(e,t,n=!0,s=0){return!!this.api_.playAnimation(e,t,n,s)}addAnimation(e,t,n=!0,s=0,a=0){return!!this.api_.addAnimation(e,t,n,s,a)}setSkin(e,t){this.api_.setSkin(e,t)}update(e,t){this.api_.update(e,t)}getAnimations(e){const t=this.api_.getAnimations(e);try{return JSON.parse(t)}catch{return[]}}getSkins(e){const t=this.api_.getSkins(e);try{return JSON.parse(t)}catch{return[]}}getBonePosition(e,t){const n=this.raw_._malloc(4),s=this.raw_._malloc(4);if(!this.api_.getBonePosition(e,t,n,s))return this.raw_._free(n),this.raw_._free(s),null;const a=this.raw_.HEAPF32[n>>2],i=this.raw_.HEAPF32[s>>2];return this.raw_._free(n),this.raw_._free(s),{x:a,y:i}}getBoneRotation(e,t){return this.api_.getBoneRotation(e,t)}getBounds(e){const t=this.raw_._malloc(16);this.api_.getBounds(e,t,t+4,t+8,t+12);const n=this.raw_.HEAPF32,s=t>>2,a={x:n[s],y:n[s+1],width:n[s+2],height:n[s+3]};return this.raw_._free(t),a}extractMeshBatches(e){const t=this.api_.getMeshBatchCount(e),n=[],s=this.raw_._malloc(8),a=s,i=s+4;for(let s=0;s<t;s++){const t=this.api_.getMeshBatchVertexCount(e,s),r=this.api_.getMeshBatchIndexCount(e,s);if(t<=0||r<=0)continue;const o=8*t*4,l=2*r,c=this.raw_._malloc(o),u=this.raw_._malloc(l);this.api_.getMeshBatchData(e,s,c,u,a,i);const p=new Float32Array(this.raw_.HEAPF32.buffer,c,8*t),d=new Uint16Array(this.raw_.HEAPU8.buffer,u,r);n.push({vertices:new Float32Array(p),indices:new Uint16Array(d),textureId:this.raw_.HEAPU32[a>>2],blendMode:this.raw_.HEAPU32[i>>2]}),this.raw_._free(c),this.raw_._free(u)}return this.raw_._free(s),n}on(e,t,n){this.listeners_.has(e)||this.listeners_.set(e,new Map);const s=this.listeners_.get(e);s.has(t)||s.set(t,new Set),s.get(t).add(n)}off(e,t,n){const s=this.listeners_.get(e);if(!s)return;const a=s.get(t);a&&a.delete(n)}removeAllListeners(e){this.listeners_.delete(e)}}const w=t(null,"SpineController"),x=new Float32Array(16);function P(e,t,n,s){const a=e.scale.x*t*(n?-1:1),i=e.scale.y*t*(s?-1:1),r=e.scale.z,o=e.rotation.x,l=e.rotation.y,c=e.rotation.z,u=e.rotation.w,p=o+o,d=l+l,h=c+c,m=o*p,_=o*d,g=o*h,b=l*d,y=l*h,f=c*h,w=u*p,P=u*d,T=u*h;return x[0]=(1-(b+f))*a,x[1]=(_+T)*a,x[2]=(g-P)*a,x[3]=0,x[4]=(_-T)*i,x[5]=(1-(m+f))*i,x[6]=(y+w)*i,x[7]=0,x[8]=(g+P)*r,x[9]=(y-w)*r,x[10]=(1-(m+b))*r,x[11]=0,x[12]=e.position.x,x[13]=e.position.y,x[14]=e.position.z,x[15]=1,x}class T{constructor(e,t){this.wasmUrl_=e,this.factory_=t}build(e){const t=e.wasmModule,n=y(this.wasmUrl_,this.factory_).then(({raw:n,api:s})=>{const a=new f(n,s);e.insertResource(w,a),e.hasResource(g)&&e.getResource(g).setSpineController(a);const i=new Map,l=new Map,c=new Map,u={_id:Symbol("SpineAutoSystem"),_name:"SpineAutoSystem",_params:[],_fn:()=>{const t=e.world,n=e.hasResource(g)?e.getResource(g):null;if(!n)return;const s=t.getEntitiesWithComponents([o]),r=new Set;for(const e of s){r.add(e);const s=t.get(e,o),u=`${s.skeletonPath}:${s.atlasPath}`;if(!i.has(e)||l.get(e)!==u){i.has(e)&&(a.destroyInstance(i.get(e)),i.delete(e),l.delete(e),c.delete(e));const t=n.getSpineSkeletonHandle(s.skeletonPath,s.atlasPath);if(void 0===t)continue;const r=a.createInstance(t);if(r<0)continue;i.set(e,r),l.set(e,u),s.skin&&a.setSkin(r,s.skin),s.animation&&a.play(r,s.animation,s.loop),c.set(e,{animation:s.animation,skin:s.skin,loop:s.loop});continue}const p=c.get(e);if(!p)continue;const d=i.get(e);p.skin!==s.skin&&(a.setSkin(d,s.skin),p.skin=s.skin),p.animation===s.animation&&p.loop===s.loop||(s.animation&&a.play(d,s.animation,s.loop),p.animation=s.animation,p.loop=s.loop)}for(const[e,t]of i)r.has(e)||(a.destroyInstance(t),i.delete(e),l.delete(e),c.delete(e))}};if(e.addSystemToSchedule(p.PreUpdate,u),!e.pipeline?.spineRenderer){let n=0;e.setSpineRenderer((s,l)=>{let c=l-n;n=l,(c<=0||c>.5)&&(c=1/60);const u=e.world;for(const[e,n]of i){const s=u.has(e,o)?u.get(e,o):null,i=!1!==s?.playing,l=s?.timeScale??1;let p;if(i&&a.update(n,c*l),u.has(e,r)){p=P(u.get(e,r),s?.skeletonScale??1,s?.flipX??!1,s?.flipY??!1)}const d=s?.color;C(t,a,n,p,d)}})}return{controller:a,coreModule:t}});e.insertResource(w,null),n.catch(()=>{}),e.spineInitPromise=n}}let A=new Float32Array(0),S=0,k=0,M=0,v=0,B=0,I=null;function U(e,t,n,s){if(t&&n>=s)return[t,n];t&&e._free(t);const a=2*s;return[e._malloc(a),a]}function C(e,t,n,s,a){I&&I!==e&&I&&(S&&(I._free(S),S=0,k=0),M&&(I._free(M),M=0,v=0),B&&(I._free(B),B=0),I=null),I=e;const i=t.extractMeshBatches(n);s&&(B||(B=e._malloc(64)),e.HEAPF32.set(s,B>>2));const r=a&&(1!==a.r||1!==a.g||1!==a.b||1!==a.a);for(const t of i){let n=t.vertices;if(r){const e=t.blendMode>=4;A.length<n.length&&(A=new Float32Array(2*n.length)),A.set(n);const s=A.subarray(0,n.length);for(let t=0;t<s.length;t+=8)e?(s[t+4]*=a.r*a.a,s[t+5]*=a.g*a.a,s[t+6]*=a.b*a.a):(s[t+4]*=a.r,s[t+5]*=a.g,s[t+6]*=a.b),s[t+7]*=a.a;n=s}const i=n.byteLength,o=t.indices.byteLength;[S,k]=U(e,S,k,i),[M,v]=U(e,M,v,o),e.HEAPF32.set(n,S>>2),new Uint16Array(e.HEAPU8.buffer,M,t.indices.length).set(t.indices),e.renderer_submitTriangles(S,n.length/8,M,t.indices.length,t.textureId,t.blendMode,s?B:0)}}export{f as SpineModuleController,T as SpinePlugin,w as SpineResource,y as loadSpineModule,C as submitSpineMeshesToCore,b as wrapSpineModule};
//# sourceMappingURL=index.js.map
