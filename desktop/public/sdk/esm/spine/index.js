let e=0;function t(t,n){const a=++e;return{_id:Symbol(`Resource_${a}_${n??""}`),_name:n??`Resource_${a}`,_default:t}}t({delta:0,elapsed:0,frameCount:0},"Time");const n=new Map;function a(e,t){const a={_id:Symbol(`Builtin_${e}`),_name:e,_cppName:e,_builtin:!0,_default:t};return n.set(e,a),a}a("LocalTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}});const r=a("WorldTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}});a("Sprite",{texture:4294967295,color:{r:1,g:1,b:1,a:1},size:{x:32,y:32},uvOffset:{x:0,y:0},uvScale:{x:1,y:1},layer:0,flipX:!1,flipY:!1,material:0}),a("Camera",{projectionType:0,fov:60,orthoSize:5,nearPlane:.1,farPlane:1e3,aspectRatio:1.77,isActive:!0,priority:0,showFrustum:!0,viewportX:0,viewportY:0,viewportW:1,viewportH:1,clearFlags:3}),a("Canvas",{designResolution:{x:1920,y:1080},pixelsPerUnit:100,scaleMode:1,matchWidthOrHeight:.5,backgroundColor:{r:0,g:0,b:0,a:1}}),a("Velocity",{linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}}),a("Parent",{entity:0}),a("Children",{entities:[]}),a("BitmapText",{text:"",color:{r:1,g:1,b:1,a:1},fontSize:1,align:0,spacing:0,layer:0,font:4294967295});const s=a("SpineAnimation",{skeletonPath:"",atlasPath:"",skin:"",animation:"",timeScale:1,loop:!0,playing:!0,flipX:!1,flipY:!1,color:{r:1,g:1,b:1,a:1},layer:0,skeletonScale:1,material:0}),i={_id:Symbol("Component_Name"),_name:"Name",_default:{value:""},_builtin:!1,create:e=>({value:"",...e})};var o,l,u;o="Name",l=i,n.set(o,l),function(e){e[e.Startup=0]="Startup",e[e.First=1]="First",e[e.PreUpdate=2]="PreUpdate",e[e.Update=3]="Update",e[e.PostUpdate=4]="PostUpdate",e[e.Last=5]="Last",e[e.FixedPreUpdate=10]="FixedPreUpdate",e[e.FixedUpdate=11]="FixedUpdate",e[e.FixedPostUpdate=12]="FixedPostUpdate"}(u||(u={}));const c=t(null,"Assets");function p(e){const t=e.cwrap.bind(e);return{loadSkeleton:t("spine_loadSkeleton","number",["number","number","string","number","number"]),getLastError:t("spine_getLastError","string",[]),unloadSkeleton:t("spine_unloadSkeleton",null,["number"]),getAtlasPageCount:t("spine_getAtlasPageCount","number",["number"]),getAtlasPageTextureName:t("spine_getAtlasPageTextureName","string",["number","number"]),setAtlasPageTexture:t("spine_setAtlasPageTexture",null,["number","number","number","number","number"]),createInstance:t("spine_createInstance","number",["number"]),destroyInstance:t("spine_destroyInstance",null,["number"]),playAnimation:t("spine_playAnimation","number",["number","string","number","number"]),addAnimation:t("spine_addAnimation","number",["number","string","number","number","number"]),setSkin:t("spine_setSkin",null,["number","string"]),update:t("spine_update",null,["number","number"]),getAnimations:t("spine_getAnimations","string",["number"]),getSkins:t("spine_getSkins","string",["number"]),getBonePosition:t("spine_getBonePosition","number",["number","string","number","number"]),getBoneRotation:t("spine_getBoneRotation","number",["number","string"]),getBounds:t("spine_getBounds",null,["number","number","number","number","number"]),getMeshBatchCount:t("spine_getMeshBatchCount","number",["number"]),getMeshBatchVertexCount:t("spine_getMeshBatchVertexCount","number",["number","number"]),getMeshBatchIndexCount:t("spine_getMeshBatchIndexCount","number",["number","number"]),getMeshBatchData:t("spine_getMeshBatchData",null,["number","number","number","number","number","number"])}}async function h(e,t){if(!t)throw new Error("SpineModuleLoader: factory parameter is required. Pass the Spine WASM factory function explicitly via loadSpineModule(url, factory).");const n=await t();return{raw:n,api:p(n)}}class m{constructor(e,t){this.raw_=e,this.api_=t,this.listeners_=new Map}get raw(){return this.raw_}loadSkeleton(e,t,n){let a,r;if("string"==typeof e){const t=(new TextEncoder).encode(e);r=t.length,a=this.raw_._malloc(r+1),this.raw_.HEAPU8.set(t,a),this.raw_.HEAPU8[a+r]=0}else r=e.length,a=this.raw_._malloc(r),this.raw_.HEAPU8.set(e,a);const s=this.api_.loadSkeleton(a,r,t,t.length,n);return this.raw_._free(a),s}getLastError(){return this.api_.getLastError()}unloadSkeleton(e){this.api_.unloadSkeleton(e)}getAtlasPageCount(e){return this.api_.getAtlasPageCount(e)}getAtlasPageTextureName(e,t){return this.api_.getAtlasPageTextureName(e,t)}setAtlasPageTexture(e,t,n,a,r){this.api_.setAtlasPageTexture(e,t,n,a,r)}createInstance(e){return this.api_.createInstance(e)}destroyInstance(e){this.api_.destroyInstance(e),this.listeners_.delete(e)}play(e,t,n=!0,a=0){return!!this.api_.playAnimation(e,t,n,a)}addAnimation(e,t,n=!0,a=0,r=0){return!!this.api_.addAnimation(e,t,n,a,r)}setSkin(e,t){this.api_.setSkin(e,t)}update(e,t){this.api_.update(e,t)}getAnimations(e){const t=this.api_.getAnimations(e);try{return JSON.parse(t)}catch{return[]}}getSkins(e){const t=this.api_.getSkins(e);try{return JSON.parse(t)}catch{return[]}}getBonePosition(e,t){const n=this.raw_._malloc(4),a=this.raw_._malloc(4);if(!this.api_.getBonePosition(e,t,n,a))return this.raw_._free(n),this.raw_._free(a),null;const r=this.raw_.HEAPF32[n>>2],s=this.raw_.HEAPF32[a>>2];return this.raw_._free(n),this.raw_._free(a),{x:r,y:s}}getBoneRotation(e,t){return this.api_.getBoneRotation(e,t)}getBounds(e){const t=this.raw_._malloc(16);this.api_.getBounds(e,t,t+4,t+8,t+12);const n=this.raw_.HEAPF32,a=t>>2,r={x:n[a],y:n[a+1],width:n[a+2],height:n[a+3]};return this.raw_._free(t),r}extractMeshBatches(e){const t=this.api_.getMeshBatchCount(e),n=[],a=this.raw_._malloc(8),r=a,s=a+4;for(let a=0;a<t;a++){const t=this.api_.getMeshBatchVertexCount(e,a),i=this.api_.getMeshBatchIndexCount(e,a);if(t<=0||i<=0)continue;const o=8*t*4,l=2*i,u=this.raw_._malloc(o),c=this.raw_._malloc(l);this.api_.getMeshBatchData(e,a,u,c,r,s);const p=new Float32Array(this.raw_.HEAPF32.buffer,u,8*t),h=new Uint16Array(this.raw_.HEAPU8.buffer,c,i);n.push({vertices:new Float32Array(p),indices:new Uint16Array(h),textureId:this.raw_.HEAPU32[r>>2],blendMode:this.raw_.HEAPU32[s>>2]}),this.raw_._free(u),this.raw_._free(c)}return this.raw_._free(a),n}on(e,t,n){this.listeners_.has(e)||this.listeners_.set(e,new Map);const a=this.listeners_.get(e);a.has(t)||a.set(t,new Set),a.get(t).add(n)}off(e,t,n){const a=this.listeners_.get(e);if(!a)return;const r=a.get(t);r&&r.delete(n)}removeAllListeners(e){this.listeners_.delete(e)}}const _=t(null,"SpineController"),d=new Float32Array(16);function g(e,t,n,a){const r=e.scale.x*t*(n?-1:1),s=e.scale.y*t*(a?-1:1),i=e.scale.z,o=e.rotation.x,l=e.rotation.y,u=e.rotation.z,c=e.rotation.w,p=o+o,h=l+l,m=u+u,_=o*p,g=o*h,b=o*m,f=l*h,w=l*m,y=u*m,S=c*p,A=c*h,P=c*m;return d[0]=(1-(f+y))*r,d[1]=(g+P)*r,d[2]=(b-A)*r,d[3]=0,d[4]=(g-P)*s,d[5]=(1-(_+y))*s,d[6]=(w+S)*s,d[7]=0,d[8]=(b+A)*i,d[9]=(w-S)*i,d[10]=(1-(_+f))*i,d[11]=0,d[12]=e.position.x,d[13]=e.position.y,d[14]=e.position.z,d[15]=1,d}class b{constructor(e,t){this.wasmUrl_=e,this.factory_=t}build(e){const t=e.wasmModule,n=h(this.wasmUrl_,this.factory_).then(({raw:n,api:a})=>{const i=new m(n,a);e.insertResource(_,i),e.hasResource(c)&&e.getResource(c).setSpineController(i);const o=new Map,l=new Map,p=new Map,h={_id:Symbol("SpineAutoSystem"),_name:"SpineAutoSystem",_params:[],_fn:()=>{const t=e.world,n=e.hasResource(c)?e.getResource(c):null;if(!n)return;const a=t.getEntitiesWithComponents([s]),r=new Set;for(const e of a){r.add(e);const a=t.get(e,s),u=`${a.skeletonPath}:${a.atlasPath}`;if(!o.has(e)||l.get(e)!==u){o.has(e)&&(i.destroyInstance(o.get(e)),o.delete(e),l.delete(e),p.delete(e));const t=n.getSpineSkeletonHandle(a.skeletonPath,a.atlasPath);if(void 0===t)continue;const r=i.createInstance(t);if(r<0)continue;o.set(e,r),l.set(e,u),a.skin&&i.setSkin(r,a.skin),a.animation&&i.play(r,a.animation,a.loop),p.set(e,{animation:a.animation,skin:a.skin,loop:a.loop});continue}const c=p.get(e);if(!c)continue;const h=o.get(e);c.skin!==a.skin&&(i.setSkin(h,a.skin),c.skin=a.skin),c.animation===a.animation&&c.loop===a.loop||(a.animation&&i.play(h,a.animation,a.loop),c.animation=a.animation,c.loop=a.loop)}for(const[e,t]of o)r.has(e)||(i.destroyInstance(t),o.delete(e),l.delete(e),p.delete(e))}};if(e.addSystemToSchedule(u.PreUpdate,h),!e.pipeline?.spineRenderer){let n=0;e.setSpineRenderer((a,l)=>{let u=l-n;n=l,(u<=0||u>.5)&&(u=1/60);const c=e.world;for(const[e,n]of o){const a=c.has(e,s)?c.get(e,s):null,o=!1!==a?.playing,l=a?.timeScale??1;let p;if(o&&i.update(n,u*l),c.has(e,r)){p=g(c.get(e,r),a?.skeletonScale??1,a?.flipX??!1,a?.flipY??!1)}const h=a?.color;M(t,i,n,p,h)}})}return{controller:i,coreModule:t}});e.insertResource(_,null),n.catch(()=>{}),e.spineInitPromise=n}}let f=new Float32Array(0),w=0,y=0,S=0,A=0,P=0,x=null;function k(e,t,n,a){if(t&&n>=a)return[t,n];t&&e._free(t);const r=2*a;return[e._malloc(r),r]}function M(e,t,n,a,r){x&&x!==e&&x&&(w&&(x._free(w),w=0,y=0),S&&(x._free(S),S=0,A=0),P&&(x._free(P),P=0),x=null),x=e;const s=t.extractMeshBatches(n);a&&(P||(P=e._malloc(64)),e.HEAPF32.set(a,P>>2));const i=r&&(1!==r.r||1!==r.g||1!==r.b||1!==r.a);for(const t of s){let n=t.vertices;if(i){const e=t.blendMode>=4;f.length<n.length&&(f=new Float32Array(2*n.length)),f.set(n);const a=f.subarray(0,n.length);for(let t=0;t<a.length;t+=8)e?(a[t+4]*=r.r*r.a,a[t+5]*=r.g*r.a,a[t+6]*=r.b*r.a):(a[t+4]*=r.r,a[t+5]*=r.g,a[t+6]*=r.b),a[t+7]*=r.a;n=a}const s=n.byteLength,o=t.indices.byteLength;[w,y]=k(e,w,y,s),[S,A]=k(e,S,A,o),e.HEAPF32.set(n,w>>2),new Uint16Array(e.HEAPU8.buffer,S,t.indices.length).set(t.indices),e.renderer_submitTriangles(w,n.length/8,S,t.indices.length,t.textureId,t.blendMode,a?P:0)}}export{m as SpineModuleController,b as SpinePlugin,_ as SpineResource,h as loadSpineModule,M as submitSpineMeshesToCore,p as wrapSpineModule};
//# sourceMappingURL=index.js.map
