function e(t){if(null===t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(e);const n={};for(const i in t)n[i]=e(t[i]);return n}let t=0;const n=new Map;function i(){return"undefined"==typeof window?n:window.__esengine_componentRegistry??(window.__esengine_componentRegistry=new Map)}const s=new Map;function o(e,t){const n={_id:Symbol(`Builtin_${e}`),_name:e,_cppName:e,_builtin:!0,_default:t};return s.set(e,n),n}const r=o("LocalTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}}),a=o("WorldTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}});o("Sprite",{texture:4294967295,color:{r:1,g:1,b:1,a:1},size:{x:32,y:32},uvOffset:{x:0,y:0},uvScale:{x:1,y:1},layer:0,flipX:!1,flipY:!1,material:0,enabled:!0}),o("Camera",{projectionType:1,fov:60,orthoSize:540,nearPlane:.1,farPlane:1e3,aspectRatio:1.77,isActive:!0,priority:0,showFrustum:!1,viewportX:0,viewportY:0,viewportW:1,viewportH:1,clearFlags:3});const l=o("Canvas",{designResolution:{x:1920,y:1080},pixelsPerUnit:100,scaleMode:1,matchWidthOrHeight:.5,backgroundColor:{r:0,g:0,b:0,a:1}});o("Velocity",{linear:{x:0,y:0,z:0},angular:{x:0,y:0,z:0}});const c=o("Parent",{entity:0});o("Children",{entities:[]}),o("BitmapText",{text:"",color:{r:1,g:1,b:1,a:1},fontSize:1,align:0,spacing:0,layer:0,font:4294967295,enabled:!0}),o("SpineAnimation",{skeletonPath:"",atlasPath:"",skin:"",animation:"",timeScale:1,loop:!0,playing:!0,flipX:!1,flipY:!1,color:{r:1,g:1,b:1,a:1},layer:0,skeletonScale:1,material:0,enabled:!0});const u={_id:Symbol("Component_Name"),_name:"Name",_default:{value:""},_builtin:!1,create:e=>({value:"",...e})};var y,p;!function(n,o){const r=s.get(n)??i().get(n);if(r)return r;const a=function(n,i){const s=++t;return{_id:Symbol(`Component_${s}_${n}`),_name:n,_default:i,_builtin:!1,create:t=>t?{...e(i),...t}:e(i)}}(n,o);i().set(n,a),s.set(n,a),function(e,t,n){"undefined"!=typeof window&&window.__esengine_registerComponent&&window.__esengine_registerComponent(e,t,n)}(n,o,!1)}("SceneOwner",{scene:"",persistent:!1}),y="Name",p=u,s.set(y,p);let _=0;function m(e,t){const n=++_;return{_id:Symbol(`Resource_${n}_${t??""}`),_name:t??`Resource_${n}`,_default:e}}const d=m({delta:0,elapsed:0,frameCount:0},"Time");var h;!function(e){e[e.Startup=0]="Startup",e[e.First=1]="First",e[e.PreUpdate=2]="PreUpdate",e[e.Update=3]="Update",e[e.PostUpdate=4]="PostUpdate",e[e.Last=5]="Last",e[e.FixedPreUpdate=10]="FixedPreUpdate",e[e.FixedUpdate=11]="FixedUpdate",e[e.FixedPostUpdate=12]="FixedPostUpdate"}(h||(h={}));let f=0;async function g(e,t){if(!t)throw new Error("PhysicsModuleLoader: factory parameter is required. Pass the Physics WASM factory function explicitly via loadPhysicsModule(url, factory).");return t()}async function b(e,t){await t.loadDynamicLibrary(new Uint8Array(e),{loadAsync:!0,allowUndefined:!0});const n=t.cwrap.bind(t);return{_physics_init:n("physics_init",null,["number","number","number","number"]),_physics_shutdown:n("physics_shutdown",null,[]),_physics_createBody:n("physics_createBody",null,["number","number","number","number","number","number","number","number","number","number"]),_physics_destroyBody:n("physics_destroyBody",null,["number"]),_physics_hasBody:n("physics_hasBody","number",["number"]),_physics_addBoxShape:n("physics_addBoxShape",null,["number","number","number","number","number","number","number","number","number"]),_physics_addCircleShape:n("physics_addCircleShape",null,["number","number","number","number","number","number","number","number"]),_physics_addCapsuleShape:n("physics_addCapsuleShape",null,["number","number","number","number","number","number","number","number","number"]),_physics_step:n("physics_step",null,["number"]),_physics_setBodyTransform:n("physics_setBodyTransform",null,["number","number","number","number"]),_physics_getDynamicBodyCount:n("physics_getDynamicBodyCount","number",[]),_physics_getDynamicBodyTransforms:n("physics_getDynamicBodyTransforms","number",[]),_physics_collectEvents:n("physics_collectEvents",null,[]),_physics_getCollisionEnterCount:n("physics_getCollisionEnterCount","number",[]),_physics_getCollisionEnterBuffer:n("physics_getCollisionEnterBuffer","number",[]),_physics_getCollisionExitCount:n("physics_getCollisionExitCount","number",[]),_physics_getCollisionExitBuffer:n("physics_getCollisionExitBuffer","number",[]),_physics_getSensorEnterCount:n("physics_getSensorEnterCount","number",[]),_physics_getSensorEnterBuffer:n("physics_getSensorEnterBuffer","number",[]),_physics_getSensorExitCount:n("physics_getSensorExitCount","number",[]),_physics_getSensorExitBuffer:n("physics_getSensorExitBuffer","number",[]),_physics_applyForce:n("physics_applyForce",null,["number","number","number"]),_physics_applyImpulse:n("physics_applyImpulse",null,["number","number","number"]),_physics_setLinearVelocity:n("physics_setLinearVelocity",null,["number","number","number"]),_physics_getLinearVelocity:n("physics_getLinearVelocity","number",["number"]),_physics_setGravity:n("physics_setGravity",null,["number","number"]),_physics_getGravity:n("physics_getGravity","number",[]),_physics_setAngularVelocity:n("physics_setAngularVelocity",null,["number","number"]),_physics_getAngularVelocity:n("physics_getAngularVelocity","number",["number"]),_physics_applyTorque:n("physics_applyTorque",null,["number","number"]),_physics_applyAngularImpulse:n("physics_applyAngularImpulse",null,["number","number"]),_physics_updateBodyProperties:n("physics_updateBodyProperties",null,["number","number","number","number","number","number","number"]),get HEAPF32(){return t.HEAPF32},get HEAPU8(){return t.HEAPU8},get HEAPU32(){return t.HEAPU32},_malloc:t._malloc.bind(t),_free:t._free.bind(t)}}const x=o("RigidBody",{bodyType:2,gravityScale:1,linearDamping:0,angularDamping:0,fixedRotation:!1,bullet:!1,enabled:!0}),E=o("BoxCollider",{halfExtents:{x:.5,y:.5},offset:{x:0,y:0},density:1,friction:.3,restitution:0,isSensor:!1,enabled:!0}),S=o("CircleCollider",{radius:.5,offset:{x:0,y:0},density:1,friction:.3,restitution:0,isSensor:!1,enabled:!0}),P=o("CapsuleCollider",{radius:.25,halfHeight:.5,offset:{x:0,y:0},density:1,friction:.3,restitution:0,isSensor:!1,enabled:!0}),w={Static:0,Kinematic:1,Dynamic:2},C=m({collisionEnters:[],collisionExits:[],sensorEnters:[],sensorExits:[]},"PhysicsEvents"),A=m(null,"PhysicsAPI");function v(e){return Math.atan2(2*(e.w*e.z+e.x*e.y),1-2*(e.y*e.y+e.z*e.z))}function B(e){const t=.5*e;return{w:Math.cos(t),x:0,y:0,z:Math.sin(t)}}class U{constructor(e,t={},n){this.wasmUrl_=e,this.factory_=n,this.config_={gravity:t.gravity??{x:0,y:-9.81},fixedTimestep:t.fixedTimestep??1/60,subStepCount:t.subStepCount??4}}build(e){e.insertResource(C,{collisionEnters:[],collisionExits:[],sensorEnters:[],sensorExits:[]});const t=new Set,n=new Map,i=g(this.wasmUrl_,this.factory_).then(i=>{i._physics_init(this.config_.gravity.x,this.config_.gravity.y,this.config_.fixedTimestep,this.config_.subStepCount);const s=function(e){const t=e.world.getEntitiesWithComponents([l]);for(const n of t){const t=e.world.get(n,l);if(t&&t.pixelsPerUnit)return t.pixelsPerUnit}return 100}(e),o=1/s,u=e.world;var y;e.addSystemToSchedule(h.PostUpdate,function(e,t,n){const i=++f;return{_id:Symbol(`System_${i}_${n?.name}`),_params:e,_fn:t,_name:n?.name??`System_${i}`}}([(y=d,{_type:"res",_resource:y})],l=>{const y=u.getEntitiesWithComponents([x,r,a]),p=new Set;for(const s of y){p.add(s);const r=u.get(s,x),l=u.get(s,a);if(t.has(s)){const e=n.get(s);!e||e.bodyType===r.bodyType&&e.gravityScale===r.gravityScale&&e.linearDamping===r.linearDamping&&e.angularDamping===r.angularDamping&&e.fixedRotation===r.fixedRotation&&e.bullet===r.bullet||(i._physics_updateBodyProperties(s,r.bodyType,r.gravityScale,r.linearDamping,r.angularDamping,r.fixedRotation?1:0,r.bullet?1:0),e.bodyType=r.bodyType,e.gravityScale=r.gravityScale,e.linearDamping=r.linearDamping,e.angularDamping=r.angularDamping,e.fixedRotation=r.fixedRotation,e.bullet=r.bullet)}else{if(!r.enabled)continue;const a=v(l.rotation);i._physics_createBody(s,r.bodyType,l.position.x*o,l.position.y*o,a,r.gravityScale,r.linearDamping,r.angularDamping,r.fixedRotation?1:0,r.bullet?1:0),T(e,i,s),t.add(s),n.set(s,{bodyType:r.bodyType,gravityScale:r.gravityScale,linearDamping:r.linearDamping,angularDamping:r.angularDamping,fixedRotation:r.fixedRotation,bullet:r.bullet})}if(r.bodyType===w.Kinematic){const e=v(l.rotation);i._physics_setBodyTransform(s,l.position.x*o,l.position.y*o,e)}}for(const e of t)p.has(e)||(i._physics_destroyBody(e),t.delete(e),n.delete(e));i._physics_step(l.delta),function(e,t,n){const i=t._physics_getDynamicBodyCount();if(0===i)return;const s=t._physics_getDynamicBodyTransforms(),o=s>>2;for(let s=0;s<i;s++){const i=o+4*s,l=t.HEAPU32[i],u=t.HEAPF32[i+1]*n,y=t.HEAPF32[i+2]*n,p=t.HEAPF32[i+3];if(!e.world.valid(l))continue;const _=e.world.get(l,r);if(!_)continue;let m=u,d=y,h=p;if(e.world.has(l,c)){const t=e.world.get(l,c);if(t&&e.world.valid(t.entity)&&e.world.has(t.entity,a)){const n=e.world.get(t.entity,a),i=v(n.rotation),s=u-n.position.x,o=y-n.position.y,r=Math.cos(-i),l=Math.sin(-i);m=(s*r-o*l)/(0!==n.scale.x?n.scale.x:1),d=(s*l+o*r)/(0!==n.scale.y?n.scale.y:1),h=p-i}}_.position.x=m,_.position.y=d;const f=B(h);_.rotation.w=f.w,_.rotation.x=f.x,_.rotation.y=f.y,_.rotation.z=f.z,e.world.insert(l,r,_)}}(e,i,s),function(e,t,n){t._physics_collectEvents();const i=[],s=t._physics_getCollisionEnterCount();if(s>0){const e=t._physics_getCollisionEnterBuffer()>>2;for(let o=0;o<s;o++){const s=e+6*o;i.push({entityA:t.HEAPU32[s],entityB:t.HEAPU32[s+1],normalX:t.HEAPF32[s+2],normalY:t.HEAPF32[s+3],contactX:t.HEAPF32[s+4]*n,contactY:t.HEAPF32[s+5]*n})}}const o=[],r=t._physics_getCollisionExitCount();if(r>0){const e=t._physics_getCollisionExitBuffer()>>2;for(let n=0;n<r;n++){const i=e+2*n;o.push({entityA:t.HEAPU32[i],entityB:t.HEAPU32[i+1]})}}const a=[],l=t._physics_getSensorEnterCount();if(l>0){const e=t._physics_getSensorEnterBuffer()>>2;for(let n=0;n<l;n++){const i=e+2*n;a.push({sensorEntity:t.HEAPU32[i],visitorEntity:t.HEAPU32[i+1]})}}const c=[],u=t._physics_getSensorExitCount();if(u>0){const e=t._physics_getSensorExitBuffer()>>2;for(let n=0;n<u;n++){const i=e+2*n;c.push({sensorEntity:t.HEAPU32[i],visitorEntity:t.HEAPU32[i+1]})}}e.insertResource(C,{collisionEnters:i,collisionExits:o,sensorEnters:a,sensorExits:c})}(e,i,s)},{name:"PhysicsSystem"})),e.physicsModule=i,e.insertResource(A,H._fromModule(i)),e.setFixedTimestep(this.config_.fixedTimestep)});i.catch(()=>{}),e.physicsInitPromise=i}}function T(e,t,n){const i=e.world;if(i.has(n,E)){const e=i.get(n,E);return void t._physics_addBoxShape(n,e.halfExtents.x,e.halfExtents.y,e.offset.x,e.offset.y,e.density,e.friction,e.restitution,e.isSensor?1:0)}if(i.has(n,S)){const e=i.get(n,S);return void t._physics_addCircleShape(n,e.radius,e.offset.x,e.offset.y,e.density,e.friction,e.restitution,e.isSensor?1:0)}if(i.has(n,P)){const e=i.get(n,P);t._physics_addCapsuleShape(n,e.radius,e.halfHeight,e.offset.x,e.offset.y,e.density,e.friction,e.restitution,e.isSensor?1:0)}}class H{constructor(e){if(this.module_=e.physicsModule,!this.module_)throw new Error("Physics module not loaded. Ensure PhysicsPlugin init is complete.")}static _fromModule(e){const t=Object.create(H.prototype);return t.module_=e,t}applyForce(e,t){this.module_._physics_applyForce(e,t.x,t.y)}applyImpulse(e,t){this.module_._physics_applyImpulse(e,t.x,t.y)}setLinearVelocity(e,t){this.module_._physics_setLinearVelocity(e,t.x,t.y)}getLinearVelocity(e){const t=this.module_._physics_getLinearVelocity(e)>>2;return{x:this.module_.HEAPF32[t],y:this.module_.HEAPF32[t+1]}}setGravity(e){this.module_._physics_setGravity(e.x,e.y)}getGravity(){const e=this.module_._physics_getGravity()>>2;return{x:this.module_.HEAPF32[e],y:this.module_.HEAPF32[e+1]}}setAngularVelocity(e,t){this.module_._physics_setAngularVelocity(e,t)}getAngularVelocity(e){return this.module_._physics_getAngularVelocity(e)}applyTorque(e,t){this.module_._physics_applyTorque(e,t)}applyAngularImpulse(e,t){this.module_._physics_applyAngularImpulse(e,t)}}export{w as BodyType,E as BoxCollider,P as CapsuleCollider,S as CircleCollider,H as Physics,A as PhysicsAPI,C as PhysicsEvents,U as PhysicsPlugin,x as RigidBody,g as loadPhysicsModule,b as loadPhysicsSideModule};
//# sourceMappingURL=index.js.map
