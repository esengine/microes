function e(e,t){return{_id:Symbol(`Builtin_${e}`),_name:e,_cppName:e,_builtin:!0,_default:t}}const t=e("RigidBody",{bodyType:2,gravityScale:1,linearDamping:0,angularDamping:0,fixedRotation:!1,bullet:!1,enabled:!0}),s=e("BoxCollider",{halfExtents:{x:.5,y:.5},offset:{x:0,y:0},density:1,friction:.3,restitution:0,isSensor:!1}),i=e("CircleCollider",{radius:.5,offset:{x:0,y:0},density:1,friction:.3,restitution:0,isSensor:!1}),n=e("CapsuleCollider",{radius:.25,halfHeight:.5,offset:{x:0,y:0},density:1,friction:.3,restitution:0,isSensor:!1}),o={Static:0,Kinematic:1,Dynamic:2};function r(e,t){return{_id:Symbol(`Builtin_${e}`),_name:e,_cppName:e,_builtin:!0,_default:t}}const a=r("LocalTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}}),l=r("WorldTransform",{position:{x:0,y:0,z:0},rotation:{w:1,x:0,y:0,z:0},scale:{x:1,y:1,z:1}}),u=r("Parent",{entity:0});let y=0;function c(e,t){const s=++y;return{_id:Symbol(`Resource_${s}_${t??""}`),_name:t??`Resource_${s}`,_default:e}}const p=c({delta:0,elapsed:0,frameCount:0},"Time");var _;!function(e){e[e.Startup=0]="Startup",e[e.First=1]="First",e[e.PreUpdate=2]="PreUpdate",e[e.Update=3]="Update",e[e.PostUpdate=4]="PostUpdate",e[e.Last=5]="Last",e[e.FixedPreUpdate=10]="FixedPreUpdate",e[e.FixedUpdate=11]="FixedUpdate",e[e.FixedPostUpdate=12]="FixedPostUpdate"}(_||(_={}));let m=0;async function d(e,t){if(t)return t();return(0,(await import(e)).default)()}async function h(e,t){await t.loadDynamicLibrary(new Uint8Array(e),{loadAsync:!0,allowUndefined:!0});const s=t.cwrap.bind(t);return{_physics_init:s("physics_init",null,["number","number","number","number"]),_physics_shutdown:s("physics_shutdown",null,[]),_physics_createBody:s("physics_createBody",null,["number","number","number","number","number","number","number","number","number","number"]),_physics_destroyBody:s("physics_destroyBody",null,["number"]),_physics_hasBody:s("physics_hasBody","number",["number"]),_physics_addBoxShape:s("physics_addBoxShape",null,["number","number","number","number","number","number","number","number","number"]),_physics_addCircleShape:s("physics_addCircleShape",null,["number","number","number","number","number","number","number","number"]),_physics_addCapsuleShape:s("physics_addCapsuleShape",null,["number","number","number","number","number","number","number","number","number"]),_physics_step:s("physics_step",null,["number"]),_physics_setBodyTransform:s("physics_setBodyTransform",null,["number","number","number","number"]),_physics_getDynamicBodyCount:s("physics_getDynamicBodyCount","number",[]),_physics_getDynamicBodyTransforms:s("physics_getDynamicBodyTransforms","number",[]),_physics_collectEvents:s("physics_collectEvents",null,[]),_physics_getCollisionEnterCount:s("physics_getCollisionEnterCount","number",[]),_physics_getCollisionEnterBuffer:s("physics_getCollisionEnterBuffer","number",[]),_physics_getCollisionExitCount:s("physics_getCollisionExitCount","number",[]),_physics_getCollisionExitBuffer:s("physics_getCollisionExitBuffer","number",[]),_physics_getSensorEnterCount:s("physics_getSensorEnterCount","number",[]),_physics_getSensorEnterBuffer:s("physics_getSensorEnterBuffer","number",[]),_physics_getSensorExitCount:s("physics_getSensorExitCount","number",[]),_physics_getSensorExitBuffer:s("physics_getSensorExitBuffer","number",[]),_physics_applyForce:s("physics_applyForce",null,["number","number","number"]),_physics_applyImpulse:s("physics_applyImpulse",null,["number","number","number"]),_physics_setLinearVelocity:s("physics_setLinearVelocity",null,["number","number","number"]),_physics_getLinearVelocity:s("physics_getLinearVelocity","number",["number"]),_physics_setGravity:s("physics_setGravity",null,["number","number"]),_physics_getGravity:s("physics_getGravity","number",[]),_physics_setAngularVelocity:s("physics_setAngularVelocity",null,["number","number"]),_physics_getAngularVelocity:s("physics_getAngularVelocity","number",["number"]),_physics_applyTorque:s("physics_applyTorque",null,["number","number"]),_physics_applyAngularImpulse:s("physics_applyAngularImpulse",null,["number","number"]),_physics_updateBodyProperties:s("physics_updateBodyProperties",null,["number","number","number","number","number","number","number"]),get HEAPF32(){return t.HEAPF32},get HEAPU8(){return t.HEAPU8},get HEAPU32(){return t.HEAPU32},_malloc:t._malloc.bind(t),_free:t._free.bind(t)}}const f=c({collisionEnters:[],collisionExits:[],sensorEnters:[],sensorExits:[]},"PhysicsEvents");function b(e){return Math.atan2(2*(e.w*e.z+e.x*e.y),1-2*(e.y*e.y+e.z*e.z))}function g(e){const t=.5*e;return{w:Math.cos(t),x:0,y:0,z:Math.sin(t)}}class x{constructor(e,t={},s){this.wasmUrl_=e,this.factory_=s,this.config_={gravity:t.gravity??{x:0,y:-9.81},fixedTimestep:t.fixedTimestep??1/60,subStepCount:t.subStepCount??4}}build(e){e.insertResource(f,{collisionEnters:[],collisionExits:[],sensorEnters:[],sensorExits:[]});const s=new Set,i=new Map,n=d(this.wasmUrl_,this.factory_).then(n=>{n._physics_init(this.config_.gravity.x,this.config_.gravity.y,this.config_.fixedTimestep,this.config_.subStepCount);const r=e.world;var y;e.addSystemToSchedule(_.PostUpdate,function(e,t,s){const i=++m;return{_id:Symbol(`System_${i}_${s?.name}`),_params:e,_fn:t,_name:s?.name??`System_${i}`}}([(y=p,{_type:"res",_resource:y})],y=>{const c=r.getEntitiesWithComponents([t,a,l]),p=new Set;for(const a of c){p.add(a);const u=r.get(a,t),y=r.get(a,l);if(s.has(a)){const e=i.get(a);!e||e.bodyType===u.bodyType&&e.gravityScale===u.gravityScale&&e.linearDamping===u.linearDamping&&e.angularDamping===u.angularDamping&&e.fixedRotation===u.fixedRotation&&e.bullet===u.bullet||(n._physics_updateBodyProperties(a,u.bodyType,u.gravityScale,u.linearDamping,u.angularDamping,u.fixedRotation?1:0,u.bullet?1:0),e.bodyType=u.bodyType,e.gravityScale=u.gravityScale,e.linearDamping=u.linearDamping,e.angularDamping=u.angularDamping,e.fixedRotation=u.fixedRotation,e.bullet=u.bullet)}else{if(!u.enabled)continue;const t=b(y.rotation);n._physics_createBody(a,u.bodyType,y.position.x,y.position.y,t,u.gravityScale,u.linearDamping,u.angularDamping,u.fixedRotation?1:0,u.bullet?1:0),E(e,n,a),s.add(a),i.set(a,{bodyType:u.bodyType,gravityScale:u.gravityScale,linearDamping:u.linearDamping,angularDamping:u.angularDamping,fixedRotation:u.fixedRotation,bullet:u.bullet})}if(u.bodyType===o.Kinematic){const e=b(y.rotation);n._physics_setBodyTransform(a,y.position.x,y.position.y,e)}}for(const e of s)p.has(e)||(n._physics_destroyBody(e),s.delete(e),i.delete(e));n._physics_step(y.delta),function(e,t){const s=t._physics_getDynamicBodyCount();if(0===s)return;const i=t._physics_getDynamicBodyTransforms(),n=i>>2;for(let i=0;i<s;i++){const s=n+4*i,o=t.HEAPU32[s],r=t.HEAPF32[s+1],y=t.HEAPF32[s+2],c=t.HEAPF32[s+3];if(!e.world.valid(o))continue;const p=e.world.get(o,a);if(!p)continue;let _=r,m=y,d=c;if(e.world.has(o,u)){const t=e.world.get(o,u);if(t&&e.world.valid(t.entity)&&e.world.has(t.entity,l)){const s=e.world.get(t.entity,l),i=b(s.rotation),n=r-s.position.x,o=y-s.position.y,a=Math.cos(-i),u=Math.sin(-i);_=(n*a-o*u)/(0!==s.scale.x?s.scale.x:1),m=(n*u+o*a)/(0!==s.scale.y?s.scale.y:1),d=c-i}}p.position.x=_,p.position.y=m;const h=g(d);p.rotation.w=h.w,p.rotation.x=h.x,p.rotation.y=h.y,p.rotation.z=h.z,e.world.insert(o,a,p)}}(e,n),function(e,t){t._physics_collectEvents();const s=[],i=t._physics_getCollisionEnterCount();if(i>0){const e=t._physics_getCollisionEnterBuffer()>>2;for(let n=0;n<i;n++){const i=e+6*n;s.push({entityA:t.HEAPU32[i],entityB:t.HEAPU32[i+1],normalX:t.HEAPF32[i+2],normalY:t.HEAPF32[i+3],contactX:t.HEAPF32[i+4],contactY:t.HEAPF32[i+5]})}}const n=[],o=t._physics_getCollisionExitCount();if(o>0){const e=t._physics_getCollisionExitBuffer()>>2;for(let s=0;s<o;s++){const i=e+2*s;n.push({entityA:t.HEAPU32[i],entityB:t.HEAPU32[i+1]})}}const r=[],a=t._physics_getSensorEnterCount();if(a>0){const e=t._physics_getSensorEnterBuffer()>>2;for(let s=0;s<a;s++){const i=e+2*s;r.push({sensorEntity:t.HEAPU32[i],visitorEntity:t.HEAPU32[i+1]})}}const l=[],u=t._physics_getSensorExitCount();if(u>0){const e=t._physics_getSensorExitBuffer()>>2;for(let s=0;s<u;s++){const i=e+2*s;l.push({sensorEntity:t.HEAPU32[i],visitorEntity:t.HEAPU32[i+1]})}}e.insertResource(f,{collisionEnters:s,collisionExits:n,sensorEnters:r,sensorExits:l})}(e,n)},{name:"PhysicsSystem"})),e.__physicsModule=n});e.__physicsInitPromise=n}}function E(e,t,o){const r=e.world;if(r.has(o,s)){const e=r.get(o,s);return void t._physics_addBoxShape(o,e.halfExtents.x,e.halfExtents.y,e.offset.x,e.offset.y,e.density,e.friction,e.restitution,e.isSensor?1:0)}if(r.has(o,i)){const e=r.get(o,i);return void t._physics_addCircleShape(o,e.radius,e.offset.x,e.offset.y,e.density,e.friction,e.restitution,e.isSensor?1:0)}if(r.has(o,n)){const e=r.get(o,n);t._physics_addCapsuleShape(o,e.radius,e.halfHeight,e.offset.x,e.offset.y,e.density,e.friction,e.restitution,e.isSensor?1:0)}}class S{constructor(e){if(this.module_=e.__physicsModule,!this.module_)throw new Error("Physics module not loaded. Ensure PhysicsPlugin init is complete.")}applyForce(e,t){this.module_._physics_applyForce(e,t.x,t.y)}applyImpulse(e,t){this.module_._physics_applyImpulse(e,t.x,t.y)}setLinearVelocity(e,t){this.module_._physics_setLinearVelocity(e,t.x,t.y)}getLinearVelocity(e){const t=this.module_._physics_getLinearVelocity(e)>>2;return{x:this.module_.HEAPF32[t],y:this.module_.HEAPF32[t+1]}}setGravity(e){this.module_._physics_setGravity(e.x,e.y)}getGravity(){const e=this.module_._physics_getGravity()>>2;return{x:this.module_.HEAPF32[e],y:this.module_.HEAPF32[e+1]}}setAngularVelocity(e,t){this.module_._physics_setAngularVelocity(e,t)}getAngularVelocity(e){return this.module_._physics_getAngularVelocity(e)}applyTorque(e,t){this.module_._physics_applyTorque(e,t)}applyAngularImpulse(e,t){this.module_._physics_applyAngularImpulse(e,t)}}export{o as BodyType,s as BoxCollider,n as CapsuleCollider,i as CircleCollider,S as Physics,f as PhysicsEvents,x as PhysicsPlugin,t as RigidBody,d as loadPhysicsModule,h as loadPhysicsSideModule};
//# sourceMappingURL=index.js.map
