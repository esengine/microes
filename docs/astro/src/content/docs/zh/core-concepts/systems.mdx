---
title: 系统
description: 在 ESEngine 中定义和调度系统
---

import { Aside } from '@astrojs/starlight/components';

系统包含游戏逻辑。它们通过参数声明需要的数据，ESEngine 自动注入。系统自动操作**场景中所有匹配的实体**。

## 定义系统

```typescript
import { defineSystem, Res, Time, Query, Mut, LocalTransform, Velocity } from 'esengine';

const movementSystem = defineSystem(
    [Res(Time), Query(Mut(LocalTransform), Velocity)],
    (time, query) => {
        for (const [entity, transform, velocity] of query) {
            transform.position.x += velocity.linear.x * time.delta;
            transform.position.y += velocity.linear.y * time.delta;
        }
    }
);
```

此系统自动处理场景中所有同时拥有 `LocalTransform` 和 `Velocity` 组件的实体。

`defineSystem` 接受两个参数：

1. **参数列表** — `Query`、`Res`、`ResMut` 或 `Commands` 描述符的数组
2. **函数** — 按相同顺序接收解析后的参数

## 注册系统

使用顶层函数注册系统：

```typescript
import { addSystem, addStartupSystem, addSystemToSchedule, Schedule } from 'esengine';

addStartupSystem(setupSystem);   // Schedule.Startup
addSystem(movementSystem);       // Schedule.Update
addSystemToSchedule(Schedule.FixedUpdate, physicsSystem);
```

### Schedule 类型

| Schedule | 运行时机 |
|----------|----------|
| `Startup` | 启动时运行一次 |
| `First` | 每帧最先运行 |
| `PreUpdate` | 每帧 Update 之前 |
| `Update` | 每帧运行（主要游戏逻辑） |
| `PostUpdate` | 每帧 Update 之后 |
| `Last` | 每帧最后运行 |
| `FixedPreUpdate` | 固定间隔，FixedUpdate 之前 |
| `FixedUpdate` | 固定间隔（物理） |
| `FixedPostUpdate` | 固定间隔，FixedUpdate 之后 |

<Aside type="note">
  Fixed 系列调度（`FixedPreUpdate`、`FixedUpdate`、`FixedPostUpdate`）以 1/60s 固定步长运行，使用累加器驱动。一帧内可能执行零次或多次，取决于帧时长，每帧最多执行 **8 次迭代**。适用于物理等需要一致时间步的确定性逻辑。
</Aside>

<Aside type="note">
  Delta time 被限制为最大 **250ms**（0.25s）。如果一帧用时更长（例如标签页不活跃），多余的时间会被丢弃以防止模拟出现大跳变。
</Aside>

## 系统参数

### Commands

在运行时创建、修改和销毁实体：

```typescript
import { Commands, Sprite, LocalTransform, Velocity, defineResource } from 'esengine';

const Score = defineResource({ value: 0 });

defineSystem([Commands()], (cmds) => {
    // 创建新实体并添加组件（可链式调用）
    const bullet = cmds.spawn()
        .insert(LocalTransform, { position: { x: 0, y: 0, z: 0 } })
        .insert(Sprite, { size: { x: 8, y: 8 } })
        .id();

    // 修改已有实体
    cmds.entity(bullet)
        .insert(Velocity, { linear: { x: 100, y: 0, z: 0 } })
        .remove(Sprite);

    // 销毁实体
    cmds.despawn(bullet);

    // 插入资源
    cmds.insertResource(Score, { value: 0 });
});
```

#### Commands API

| 方法 | 返回值 | 说明 |
|------|--------|------|
| `cmds.spawn()` | `EntityCommands` | 创建新实体，返回构建器 |
| `cmds.entity(entity)` | `EntityCommands` | 获取已有实体的构建器 |
| `cmds.despawn(entity)` | `this` | 将实体加入销毁队列 |
| `cmds.insertResource(res, value)` | `this` | 插入或覆盖资源 |

#### EntityCommands API

`spawn()` 和 `entity()` 返回 `EntityCommands` 构建器，所有方法可链式调用：

| 方法 | 返回值 | 说明 |
|------|--------|------|
| `.insert(component, data?)` | `this` | 添加或更新组件 |
| `.remove(component)` | `this` | 移除组件 |
| `.id()` | `Entity` | 获取实体 ID |

<Aside type="note">
  Commands 是缓冲的，在系统函数返回后才统一应用，不会在执行过程中立即生效。例外是 `.id()` — 调用它会立即创建实体，使 ID 可以马上使用。
</Aside>

### Query

遍历具有特定组件的实体：

```typescript
import { Query, Mut, LocalTransform, Sprite } from 'esengine';

defineSystem([Query(Mut(LocalTransform), Sprite)], (query) => {
    for (const [entity, transform, sprite] of query) {
        transform.position.x += 1;
    }
});
```

详见[查询](/microes/zh/core-concepts/queries/)。

### Res（只读资源）

```typescript
import { Res, Time } from 'esengine';

defineSystem([Res(Time)], (time) => {
    console.log(`Delta: ${time.delta}s`);
});
```

### ResMut（可变资源）

```typescript
import { ResMut } from 'esengine';

defineSystem([ResMut(GameState)], (state) => {
    state.get().score += 10;
});
```

详见[资源](/microes/zh/core-concepts/resources/)。

### 组合参数

```typescript
defineSystem(
    [Commands(), Res(Time), Res(Input), Query(Mut(LocalTransform), Velocity)],
    (cmds, time, input, query) => {
        // 所有参数都可用
    }
);
```

## 示例：玩家移动

定义 `Speed` 组件，在编辑器中挂载到玩家实体上，然后编写系统：

```typescript
// src/components/Speed.ts
import { defineComponent } from 'esengine';
export const Speed = defineComponent('Speed', { value: 200 });
```

```typescript
// src/systems/movement.ts
import { defineSystem, addSystem, Res, Time, Input, Query, Mut, LocalTransform } from 'esengine';
import { Speed } from '../components/Speed';

addSystem(defineSystem(
    [Res(Time), Res(Input), Query(Mut(LocalTransform), Speed)],
    (time, input, query) => {
        for (const [entity, transform, speed] of query) {
            if (input.isKeyDown('KeyD')) {
                transform.position.x += speed.value * time.delta;
            }
            if (input.isKeyDown('KeyA')) {
                transform.position.x -= speed.value * time.delta;
            }
        }
    }
));
```

## 错误处理

每个系统在独立的 try/catch 边界内运行。如果系统抛出错误，会被捕获并输出到控制台，不会导致整个游戏循环崩溃。其他系统继续正常执行。

## 下一步

- [查询](/microes/zh/core-concepts/queries/) — 查询过滤器和迭代方法
- [资源](/microes/zh/core-concepts/resources/) — 全局单例数据
