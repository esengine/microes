---
title: 构建
description: 将 ESEngine 项目构建到不同平台
---

import { Aside } from '@astrojs/starlight/components';

ESEngine 项目可以从编辑器构建到两个目标平台：**可玩广告**（单个自包含 HTML 文件）和**微信小游戏**（可直接在微信开发者工具中打开的目录结构）。

## 构建目标

| 平台 | 输出 | 说明 |
|------|------|------|
| 可玩广告 | 单个 `.html` 文件 | 所有资源、WASM 和脚本内联到一个文件中。适用于要求单文件交付的广告平台。 |
| 微信小游戏 | 目录 | 包含 `game.js`、`game.json`、`project.config.json`、场景文件和资源。可直接在微信开发者工具中打开。 |

## 使用构建面板

从编辑器工具栏打开**构建**面板。面板采用三栏布局：

1. **左侧边栏** — 列出平台和构建配置。点击平台进行筛选，然后选择一个配置。
2. **中间详情** — 显示所选配置的设置：场景列表、脚本定义和平台专属选项。
3. **右侧输出** — 显示构建历史、状态、输出大小和操作按钮（打开文件夹、预览）。

### 创建构建配置

点击工具栏中的**添加**来创建新配置。选择名称和目标平台。编辑器还提供了预置的**模板**（通过模板按钮访问），包含"可玩广告生产版"或"微信开发版"等常用配置。

### 执行构建

1. 从侧边栏选择一个配置
2. 检查场景列表——点击**添加当前场景**可以将编辑器中当前打开的场景加入列表
3. 根据需要调整平台专属设置
4. 点击**构建**（或按 `Cmd/Ctrl + B`）

构建进度和日志通过 Toast 通知实时显示。构建完成后，可以点击**打开文件夹**导航到输出位置。

<Aside type="tip">
  使用**全部构建**可以依次构建所有配置。这在同时需要开发版和生产版构建时很有用。
</Aside>

## 构建配置

每个配置包含：

| 设置 | 作用 |
|------|------|
| **名称** | 此配置的可读标签 |
| **平台** | 目标平台：可玩广告或微信小游戏 |
| **场景** | 要包含在构建中的 `.esscene` 文件列表 |
| **脚本定义** | 编译时定义（如 `DEBUG`）。可在脚本中通过 `process.env.DEBUG` 访问。 |
| **平台设置** | 平台专属选项（见下文） |

### 可玩广告设置

| 设置 | 描述 |
|------|------|
| **启动场景** | 启动时加载的场景（默认为列表中的第一个场景） |
| **开发构建** | 在输出中包含调试信息 |
| **代码压缩** | 压缩打包后的 JavaScript 以减小体积 |
| **嵌入字体** | 将字体文件内联到 HTML 中 |
| **输出路径** | 输出 `.html` 文件的写入位置（如 `build/playable.html`） |
| **启用内置 CTA** | 显示内置的 "Install Now" 行动号召按钮 |
| **CTA URL** | 点击 CTA 按钮时打开的目标 URL |

<Aside type="note">
  可玩广告将所有内容嵌入到单个 HTML 文件中——WASM 二进制、纹理、场景数据和脚本都以 base64 编码内联。
</Aside>

### 微信小游戏设置

| 设置 | 描述 |
|------|------|
| **AppID** | 微信小游戏 AppID。测试时可使用 `touristappid`（无需注册应用）。 |
| **版本** | 版本字符串（如 `1.0.0`） |
| **屏幕方向** | `竖屏`（Portrait）或 `横屏`（Landscape） |
| **打包模式** | `分包`（推荐）、`单包` 或 `单文件` |
| **输出目录** | 输出目录的写入位置（如 `build/wechat`） |

## 资源导出配置

构建系统通过三种模式决定包含哪些资源，可在编辑器中按文件夹配置：

| 模式 | 行为 |
|------|------|
| `auto`（默认） | 仅包含在构建场景或预制体中被引用的资源 |
| `always` | 无论是否被引用，始终包含该文件夹下所有资源 |
| `exclude` | 永不包含该文件夹下的资源 |

资源导出模式存储在 `.esengine/asset-export.json` 中：

```json
{
    "version": "1.0",
    "folders": {
        "assets/ui": "always",
        "assets/debug": "exclude"
    }
}
```

文件夹会继承父级的模式。例如，如果 `assets/sprites` 设为 `always`，`assets/sprites/enemies/` 下的所有文件也会被包含。

## 构建流程

点击构建后，编辑器会运行以下流水线：

### 1. 资源收集

构建扫描场景文件并递归收集：

- `Sprite`、`SpineRenderer` 等组件引用的纹理
- 材质及其着色器依赖
- Spine 图集文件及其纹理页
- 位图字体文件及其字形纹理
- 嵌套预制体及其传递性资源引用

### 2. 图集打包

引用的图片会被打包到纹理图集页中（默认最大 2048x2048）。场景数据会被重写为使用图集坐标，运行时精灵会自动引用打包后的图集。

### 3. 材质编译

`.esmaterial` 文件被编译为 JSON，解析着色器引用并内联属性值。

### 4. 脚本打包

`src/` 目录下的用户脚本通过 esbuild 编译打包。`esengine` SDK 作为外部模块处理——在可玩广告中内联，在微信小游戏中从 `sdk.js` 加载。

### 5. 平台输出

为目标平台生成最终产物：

- **可玩广告** — 将所有资源 base64 编码内联，组装成单个 HTML 文件
- **微信小游戏** — 写入包含 `game.js`、`game.json`、`project.config.json`、场景、资源和 WASM 文件的目录

## 输出结构

### 可玩广告

```
build/
  playable.html          # 单个自包含文件
```

### 微信小游戏

```
build/wechat/
  project.config.json    # 微信开发者工具项目配置
  game.json              # 小游戏清单
  game.js                # 入口文件（引擎初始化 + 用户脚本）
  esengine.js            # WASM 引擎加载器
  esengine.wasm          # 引擎 WASM 二进制
  sdk.js                 # SDK 运行时
  spine.js / spine.wasm  # Spine 运行时（如果启用了 Spine）
  physics.js / physics.wasm  # 物理引擎（如果启用了物理）
  atlas_0.png            # 打包的纹理图集页
  asset-manifest.json    # 可寻址资源清单
  scenes/
    Level1.json          # 导出的场景数据
  assets/
    ...                  # 未打包的资源文件
```

## 可寻址清单

两个平台都会生成 `asset-manifest.json`，将资源 UUID 映射到运行时路径。这使运行时能够通过 UUID 或地址解析资源，并从打包的图集页中重建图集帧。

```json
{
    "version": "2.0",
    "groups": {
        "default": {
            "bundleMode": "together",
            "labels": [],
            "assets": {
                "uuid-1": {
                    "path": "assets/sprites/player.png",
                    "type": "texture",
                    "size": 1024,
                    "labels": ["character"]
                }
            }
        }
    }
}
```

## 项目设置

构建行为还受项目级设置的影响：

| 设置 | 效果 |
|------|------|
| Spine 版本 | 在构建中包含 Spine 运行时 WASM 模块 |
| 启用物理 | 在构建中包含物理 WASM 模块并生成物理配置 |
| 物理重力 | 在物理配置中设置重力向量 |
| 物理时间步 | 设置固定的物理模拟时间步长 |
